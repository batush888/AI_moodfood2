<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoodFood - Find Food That Matches Your Mood</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #fff8f0 0%, #ffffff 100%);
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid #fed7aa;
            position: sticky;
            top: 0;
            z-index: 50;
            padding: 1rem 0;
        }

        .header-content {
            max-width: 72rem;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: inherit;
        }

        .logo-icon {
            width: 2.5rem;
            height: 2.5rem;
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: 0 2px 4px rgba(249, 115, 22, 0.2);
        }

        .logo-text h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .logo-text p {
            font-size: 0.75rem;
            color: #6b7280;
            margin: 0;
        }

        .nav {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: 9999px;
            text-decoration: none;
            color: #6b7280;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            color: #f97316;
            background: rgba(249, 115, 22, 0.05);
        }

        .nav-item.active {
            background: #fed7aa;
            color: #ea580c;
            border-color: #f97316;
        }

        /* Main Content */
        .main {
            max-width: 72rem;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .hero {
            text-align: center;
            margin-bottom: 2rem;
        }

        .hero h2 {
            font-size: 3rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .hero .highlight {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p {
            font-size: 1.125rem;
            color: #6b7280;
            max-width: 32rem;
            margin: 0 auto 2rem;
        }

        /* Search Input */
        .search-container {
            max-width: 48rem;
            margin: 0 auto 2rem;
            position: relative;
        }

        .search-form {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 1.5rem 3rem 1.5rem 3rem;
            font-size: 1.125rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border: 2px solid #fed7aa;
            border-radius: 1.5rem;
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1), 0 8px 25px -5px rgba(0, 0, 0, 0.15);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #f97316;
            font-size: 1.25rem;
        }

        .search-button {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: #f97316;
            color: white;
            border: none;
            border-radius: 0.75rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(249, 115, 22, 0.2);
        }

        .search-button:hover {
            background: #ea580c;
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 4px 8px rgba(249, 115, 22, 0.3);
        }

        .search-button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: translateY(-50%);
            box-shadow: none;
        }

        /* Suggestions Dropdown */
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.5rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-radius: 1.5rem;
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.15);
            border: 1px solid #fed7aa;
            padding: 1.5rem;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .suggestions-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .suggestions-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 1rem;
        }

        .suggestions-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .suggestion-chip {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .suggestion-chip:hover {
            background: #fef3c7;
            border-color: #f97316;
            color: #92400e;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(249, 115, 22, 0.1);
        }

        /* Context Controls */
        .context-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }

        .control-input {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            transition: all 0.2s;
        }

        .control-input:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .time-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .weather-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #dbeafe;
            border: 1px solid #3b82f6;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        /* AI Analysis */
        .ai-analysis {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .ai-title {
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 1rem;
            font-size: 1.125rem;
        }

        .ai-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .ai-item {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            border: 1px solid #e0f2fe;
        }

        .detail-label {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-weight: 600;
            color: #0f172a;
        }

        /* Results */
        .results-section {
            margin-top: 2rem;
        }

        .recommendation-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            overflow: hidden;
            border: 1px solid #f3f4f6;
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .food-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }

        .food-score {
            background: #f97316;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
        }

        .food-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .detail-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        .detail-value {
            font-weight: 600;
            color: #1f2937;
        }

        .reasoning {
            background: #fef3c7;
            padding: 1.5rem;
            border-top: 1px solid #f3f4f6;
        }

        .reasoning h4 {
            color: #92400e;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .reasoning ul {
            list-style: none;
            padding: 0;
        }

        .reasoning li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #fde68a;
            color: #92400e;
        }

        .reasoning li:last-child {
            border-bottom: none;
        }

        /* Loading and Error States */
        .loading-section {
            text-align: center;
            padding: 3rem 1rem;
        }

        .loading-spinner {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            color: #f97316;
        }

        .spinner {
            width: 2rem;
            height: 2rem;
            border: 3px solid #f97316;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-section {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            color: #dc2626;
        }

        /* Feedback Section */
        .feedback-section {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .feedback-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .rating-stars {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .star {
            font-size: 1.5rem;
            color: #d1d5db;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star.active {
            color: #fbbf24;
        }

        .feedback-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 1rem;
        }

        .feedback-button {
            background: #f97316;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .feedback-button:hover {
            background: #ea580c;
        }

        /* Debug Section */
        .debug-section {
            background: #1f2937;
            color: #f9fafb;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-top: 2rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.875rem;
        }

        .debug-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: rgba(31, 41, 55, 0.8);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            z-index: 1000;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .hero h2 {
                font-size: 2rem;
            }

            .nav {
                display: none;
            }

            .context-controls {
                grid-template-columns: 1fr;
            }

            .ai-details {
                grid-template-columns: 1fr;
            }

            .food-details {
                grid-template-columns: 1fr;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .show {
            display: block !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo">
                <div class="logo-icon">üçΩÔ∏è</div>
                <div class="logo-text">
                    <h1>MoodFood</h1>
                    <p>Find food that matches your mood</p>
                </div>
            </a>
            <nav class="nav">
                <a href="#" class="nav-item active">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <span>Search</span>
                </a>
                <a href="#" class="nav-item">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                    <span>Favorites</span>
                </a>
                <a href="#" class="nav-item">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span>Profile</span>
                </a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <!-- Hero Section -->
        <div class="hero">
            <h2>What's your <span class="highlight">craving</span>?</h2>
            <p>Tell us your mood and we'll find the perfect dishes for you, along with the best places to get them.</p>
        </div>

        <!-- Search Input -->
        <div class="search-container">
            <form class="search-form" id="searchForm">
                <input 
                    type="text" 
                    id="textInput" 
                    class="search-input" 
                    placeholder="What are you craving today?"
                    required
                >
                <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                </svg>
                <button type="submit" class="search-button" id="searchButton">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
                    </svg>
                </button>
            </form>
            
            <!-- Suggestions Dropdown -->
            <div class="suggestions-dropdown" id="suggestionsDropdown">
                <div class="suggestions-title">Try these suggestions:</div>
                <div class="suggestions-grid">
                    <div class="suggestion-chip" data-suggestion="I want something light and healthy">I want something light and healthy</div>
                    <div class="suggestion-chip" data-suggestion="Craving spicy and bold flavors">Craving spicy and bold flavors</div>
                    <div class="suggestion-chip" data-suggestion="Need some warm comfort food">Need some warm comfort food</div>
                    <div class="suggestion-chip" data-suggestion="Looking for a romantic dinner">Looking for a romantic dinner</div>
                    <div class="suggestion-chip" data-suggestion="Something quick for lunch">Something quick for lunch</div>
                    <div class="suggestion-chip" data-suggestion="I feel like celebrating!">I feel like celebrating!</div>
                </div>
            </div>
        </div>

        <!-- Context Controls -->
        <div class="context-controls">
            <div class="control-group">
                <label class="control-label">Time of Day</label>
                <div class="time-display" id="timeDisplay">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12,6 12,12 16,14"></polyline>
                    </svg>
                    <span id="currentTime">Loading...</span>
                    <span id="timeCategory">Morning</span>
                </div>
                <input type="hidden" id="timeOfDay" value="morning">
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button type="button" id="refreshTime" style="padding: 0.5rem 0.75rem; background: #f97316; color: white; border: none; border-radius: 0.5rem; font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem;">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="23,4 23,10 17,10"></polyline>
                            <polyline points="1,20 1,14 7,14"></polyline>
                            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                        </svg>
                        Refresh
                    </button>
                    <button type="button" id="timeFormatToggle" style="padding: 0.5rem 0.75rem; background: #6b7280; color: white; border: none; border-radius: 0.5rem; font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem;">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12,6 12,12 16,14"></polyline>
                        </svg>
                        12/24
                    </button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Weather</label>
                <input type="text" id="weather" class="control-input" placeholder="Enter weather (optional)">
                <div class="weather-display" id="weatherDisplay">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <span id="weatherText">Detecting weather...</span>
                </div>
                <button type="button" id="refreshWeather" style="padding: 0.5rem 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 0.5rem; font-size: 0.75rem; margin-top: 0.5rem; display: flex; align-items: center; gap: 0.25rem;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23,4 23,10 17,10"></polyline>
                        <polyline points="1,20 1,14 7,14"></polyline>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                    </svg>
                    Refresh
                </button>
            </div>

            <div class="control-group">
                <label class="control-label">Social Context</label>
                <select id="socialContext" class="control-input">
                    <option value="">Select social context</option>
                    <option value="alone">Alone</option>
                    <option value="family">Family</option>
                    <option value="friends">Friends</option>
                    <option value="romantic">Romantic</option>
                    <option value="business">Business</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Energy Level</label>
                <select id="energyLevel" class="control-input">
                    <option value="">Select energy level</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
        </div>

        <!-- AI Analysis Section -->
        <div class="ai-analysis hidden" id="aiAnalysis">
            <div class="ai-title">ü§ñ AI Analysis</div>
            <div class="ai-details">
                <div class="ai-item">
                    <div class="detail-label">Primary Intent</div>
                    <div class="detail-value" id="primaryIntent">-</div>
                </div>
                <div class="ai-item">
                    <div class="detail-label">Confidence</div>
                    <div class="detail-value" id="intentConfidence">-</div>
                </div>
                <div class="ai-item">
                    <div class="detail-label">Processing Time</div>
                    <div class="detail-value" id="processingTime">-</div>
                </div>
            </div>
        </div>

        <!-- Loading Section -->
        <div class="loading-section hidden" id="loadingSection">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <span>Finding your perfect dishes...</span>
            </div>
        </div>

        <!-- Error Section -->
        <div class="error-section hidden" id="errorSection">
            <div id="errorMessage">An error occurred</div>
        </div>

        <!-- Results Section -->
        <div class="results-section hidden" id="resultsSection">
            <div id="recommendationsList"></div>
        </div>

        <!-- Feedback Section -->
        <div class="feedback-section hidden" id="feedbackSection">
            <div class="feedback-title">How was your experience?</div>
            <div class="rating-stars">
                <span class="star" data-rating="1">‚≠ê</span>
                <span class="star" data-rating="2">‚≠ê</span>
                <span class="star" data-rating="3">‚≠ê</span>
                <span class="star" data-rating="4">‚≠ê</span>
                <span class="star" data-rating="5">‚≠ê</span>
            </div>
            <textarea class="feedback-textarea" id="feedbackText" placeholder="Tell us more about your experience..."></textarea>
            <button class="feedback-button" onclick="submitFeedback()">Submit Feedback</button>
        </div>

        <!-- Debug Section -->
        <div class="debug-section hidden" id="debugSection">
            <h3>Debug Information</h3>
            <p><strong>API Base:</strong> <span id="debugApiBase">-</span></p>
            <p><strong>Request:</strong></p>
            <pre id="debugRequest">-</pre>
            <p><strong>Response:</strong></p>
            <pre id="debugResponse">-</pre>
            <p><strong>Performance:</strong></p>
            <pre id="debugPerformance">-</pre>
        </div>
    </main>

    <!-- Debug Toggle -->
    <button class="debug-toggle" onclick="toggleDebug()">Debug</button>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8000';
        let currentRecommendations = null;
        let currentRating = 0;
        let hasSearched = false;

        // Time system variables
        let _timeInterval = null;
        let _use24Hour = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeTimeSystem();
            initializeWeatherSystem();
            setupEventListeners();
            loadUserPreferences();
        });

        // Time system functions
        function initializeTimeSystem() {
            initializeTimeDetection();
            setupTimeRefresh();
        }

        function initializeTimeDetection() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', updateTimeDisplay);
            } else {
                updateTimeDisplay();
            }
            
            // Update time every minute
            _timeInterval = setInterval(updateTimeDisplay, 60000);
        }

        function updateTimeDisplay() {
            if (document.readyState !== 'complete') return;
            
            const now = new Date();
            const currentTimeElement = document.getElementById('currentTime');
            const timeCategoryElement = document.getElementById('timeCategory');
            const timeOfDayInput = document.getElementById('timeOfDay');
            
            if (!currentTimeElement || !timeCategoryElement || !timeOfDayInput) return;
            
            // Format current time based on user preference
            const timeString = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: !_use24Hour
            });
            currentTimeElement.textContent = timeString;
            
            // Determine time category
            const hour = now.getHours();
            let timeCategory, timeValue;
            
            if (hour >= 5 && hour < 12) {
                timeCategory = 'Morning';
                timeValue = 'morning';
            } else if (hour >= 12 && hour < 17) {
                timeCategory = 'Afternoon';
                timeValue = 'afternoon';
            } else if (hour >= 17 && hour < 21) {
                timeCategory = 'Evening';
                timeValue = 'evening';
            } else {
                timeCategory = 'Night';
                timeValue = 'night';
            }
            
            timeCategoryElement.textContent = timeCategory;
            timeOfDayInput.value = timeValue;
        }

        function setupTimeRefresh() {
            const refreshBtn = document.getElementById('refreshTime');
            const formatBtn = document.getElementById('timeFormatToggle');
            
            if (!refreshBtn || !formatBtn) return;
            
            refreshBtn.onclick = function() {
                updateTimeDisplay();
            };
            
            formatBtn.onclick = function() {
                _use24Hour = !_use24Hour;
                updateTimeDisplay();
                saveUserPreferences();
            };
        }

        function loadUserPreferences() {
            const savedFormat = localStorage.getItem('timeFormat24Hour');
            if (savedFormat !== null) {
                _use24Hour = savedFormat === 'true';
            }
        }

        function saveUserPreferences() {
            localStorage.setItem('timeFormat24Hour', _use24Hour.toString());
        }

        // Weather system functions
        const GAODE_API_KEY = 'f2f2807dd694c0e3e46d99bc30e9139f';
        let currentWeather = 'unknown';
        let userLocation = null;

        async function getCurrentWeather() {
            try {
                const manualWeather = document.getElementById("weather")?.value?.trim();
                if (manualWeather) {
                    currentWeather = manualWeather;
                    updateWeatherDisplayManual(manualWeather);
                    return manualWeather;
                }
                
                if (!userLocation) {
                    userLocation = await getUserLocation();
                }
                
                if (!userLocation) {
                    throw new Error('Unable to get user location');
                }
                
                try {
                    const weatherData = await fetchGaodeWeatherWithGeocoding(userLocation.latitude, userLocation.longitude);
                    
                    if (!weatherData) {
                        throw new Error('No weather data received from Gaode API');
                    }
                    
                    const weatherCategory = categorizeGaodeWeather(weatherData);
                    updateWeatherDisplay(weatherData, weatherCategory);
                    document.getElementById('weather').value = weatherCategory;
                    currentWeather = weatherCategory;
                    return weatherCategory;
                    
                } catch (apiError) {
                    try {
                        const timeOfDay = getTimeOfDay();
                        const feedbackWeather = await fetchRecentFeedbackWeather(timeOfDay);
                        
                        if (feedbackWeather && feedbackWeather !== 'unknown') {
                            currentWeather = feedbackWeather;
                            updateWeatherDisplayManual(feedbackWeather);
                            document.getElementById('weather').value = feedbackWeather;
                            return feedbackWeather;
                        }
                    } catch (feedbackError) {
                        console.log('Feedback fallback failed:', feedbackError);
                    }
                    
                    const seasonalWeather = getSeasonalDefaultWeather();
                    currentWeather = seasonalWeather;
                    updateWeatherDisplayManual(seasonalWeather);
                    document.getElementById('weather').value = seasonalWeather;
                    return seasonalWeather;
                }
                
            } catch (error) {
                console.error('All weather methods failed:', error);
                const fallbackWeather = getSeasonalDefaultWeather();
                currentWeather = fallbackWeather;
                updateWeatherDisplayManual(fallbackWeather);
                document.getElementById('weather').value = fallbackWeather;
                return fallbackWeather;
            }
        }

        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    resolve({ latitude: 37.7749, longitude: -122.4194 });
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        resolve(location);
                    },
                    (error) => {
                        resolve({ latitude: 37.7749, longitude: -122.4194 });
                    },
                    { timeout: 5000, enableHighAccuracy: false }
                );
            });
        }

        function getTimeOfDay() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 12) return 'morning';
            if (hour >= 12 && hour < 17) return 'afternoon';
            if (hour >= 17 && hour < 21) return 'evening';
            return 'night';
        }

        function getSeasonalDefaultWeather() {
            const month = new Date().getMonth();
            if (month >= 6 && month <= 8) return "hot";
            if (month >= 9 && month <= 11) return "mild";
            if (month >= 12 || month <= 2) return "cold";
            return "mild";
        }

        async function fetchRecentFeedbackWeather(timeOfDay) {
            try {
                const response = await fetch('http://localhost:8000/recent-feedback-weather', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ 
                        user_id: "user123", 
                        time_of_day: timeOfDay 
                    }),
                    signal: AbortSignal.timeout(5000)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.weather && data.weather !== 'unknown') {
                        return data.weather;
                    }
                }
                
                return 'unknown';
                
            } catch (error) {
                return 'unknown';
            }
        }

        async function fetchGaodeWeatherWithGeocoding(lat, lng) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const geoResponse = await fetch(
                    `https://restapi.amap.com/v3/geocode/regeo?location=${lng},${lat}&key=${GAODE_API_KEY}`,
                    {
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'Mozilla/5.0 (compatible; WeatherApp/1.0)'
                        }
                    }
                );
                
                clearTimeout(timeoutId);
                
                if (!geoResponse.ok) {
                    throw new Error(`Gaode Geocode API error: ${geoResponse.status}`);
                }
                
                const geoData = await geoResponse.json();
                
                if (geoData.status !== '1' || !geoData.regeocode || !geoData.regeocode.adcode) {
                    throw new Error('Invalid geocode response');
                }
                
                const adcode = geoData.regeocode.adcode;
                
                const weatherResponse = await fetch(
                    `https://restapi.amap.com/v3/weather/weatherInfo?city=${adcode}&key=${GAODE_API_KEY}&extensions=base`,
                    {
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'Mozilla/5.0 (compatible; WeatherApp/1.0)'
                        }
                    }
                );
                
                if (!weatherResponse.ok) {
                    throw new Error(`Gaode Weather API error: ${weatherResponse.status}`);
                }
                
                const weatherData = await weatherResponse.json();
                
                if (weatherData.status === '1' && weatherData.lives && weatherData.lives.length > 0) {
                    return weatherData.lives[0];
                } else {
                    throw new Error(`Weather API error: ${weatherData.info || 'Unknown error'}`);
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('Gaode API request timed out');
                }
                throw error;
            }
        }

        function categorizeGaodeWeather(weatherData) {
            const temperature = parseFloat(weatherData.temperature);
            const weatherCondition = weatherData.weather;
            
            const weatherMap = {
                "Êô¥": "sunny",
                "Â§ö‰∫ë": "cloudy",
                "Èò¥": "cloudy",
                "Èõ®": "rainy",
                "Â∞èÈõ®": "rainy",
                "‰∏≠Èõ®": "rainy",
                "Â§ßÈõ®": "rainy",
                "Èõ™": "snowy",
                "Â∞èÈõ™": "snowy",
                "‰∏≠Èõ™": "snowy",
                "Â§ßÈõ™": "snowy",
                "Èõæ": "foggy",
                "Èúæ": "hazy"
            };
            
            const mappedCondition = weatherMap[weatherCondition] || "unknown";
            
            if (temperature > 25) return "hot";
            if (temperature < 10) return "cold";
            if (temperature >= 10 && temperature <= 25) return "warm";
            
            return mappedCondition !== "unknown" ? mappedCondition : "moderate";
        }

        function updateWeatherDisplayManual(weatherCategory) {
            const weatherDisplay = document.getElementById('weatherDisplay');
            const weatherText = document.getElementById('weatherText');
            
            if (!weatherDisplay || !weatherText) return;
            
            // Update the SVG icon based on weather
            const svgIcon = weatherDisplay.querySelector('svg');
            if (svgIcon) {
                const iconMap = {
                    'hot': `<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`,
                    'cold': `<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>`,
                    'warm': `<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`,
                    'rainy': `<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path><path d="M8 21l4-7 4 7"></path>`,
                    'cloudy': `<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>`,
                    'sunny': `<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`,
                    'snowy': `<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>`,
                    'foggy': `<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>`,
                    'hazy': `<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>`,
                    'mild': `<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`,
                    'moderate': `<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`
                };
                
                svgIcon.innerHTML = iconMap[weatherCategory] || iconMap['mild'];
            }
            
            weatherText.textContent = `${weatherCategory.charAt(0).toUpperCase() + weatherCategory.slice(1)} (auto)`;
        }

        function updateWeatherDisplay(weatherData, weatherCategory) {
            const weatherDisplay = document.getElementById('weatherDisplay');
            const weatherText = document.getElementById('weatherText');
            
            // Update the SVG icon based on weather
            const svgIcon = weatherDisplay.querySelector('svg');
            if (svgIcon) {
                const iconMap = {
                    'hot': `<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`,
                    'cold': `<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>`,
                    'warm': `<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`,
                    'rainy': `<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path><path d="M8 21l4-7 4 7"></path>`,
                    'cloudy': `<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>`,
                    'sunny': `<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`,
                    'moderate': `<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`
                };
                
                svgIcon.innerHTML = iconMap[weatherCategory] || iconMap['moderate'];
            }
            
            const temp = weatherData.temperature;
            const condition = weatherData.weather;
            weatherText.textContent = `${condition} ${temp}¬∞C`;
        }

        function setupWeatherRefresh() {
            const refreshBtn = document.getElementById('refreshWeather');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    getCurrentWeather();
                });
            }
        }

        function initializeWeatherSystem() {
            setupWeatherRefresh();
            getCurrentWeather();
        }

        // Event listeners
        function setupEventListeners() {
            document.getElementById('searchForm').addEventListener('submit', getEnhancedRecommendations);
            
            // Suggestions dropdown
            const textInput = document.getElementById('textInput');
            const suggestionsDropdown = document.getElementById('suggestionsDropdown');
            
            // Show suggestions on focus (only if no search has been performed yet)
            textInput.addEventListener('focus', function() {
                if (!hasSearched) {
                    suggestionsDropdown.classList.add('show');
                }
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(event) {
                if (!textInput.contains(event.target) && !suggestionsDropdown.contains(event.target)) {
                    suggestionsDropdown.classList.remove('show');
                }
            });
            
            // Handle suggestion clicks
            document.querySelectorAll('.suggestion-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    const suggestion = this.dataset.suggestion;
                    textInput.value = suggestion;
                    suggestionsDropdown.classList.remove('show');
                    getEnhancedRecommendations(new Event('submit'));
                });
            });
            
            // Star rating
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    currentRating = rating;
                    
                    document.querySelectorAll('.star').forEach((s, index) => {
                        if (index < rating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
            });
        }

        // Main recommendation function
        async function getEnhancedRecommendations(e) {
            e.preventDefault();
            
            hasSearched = true;
            document.getElementById('suggestionsDropdown').classList.remove('show');
            
            // Update placeholder text after first search
            const textInput = document.getElementById('textInput');
            if (textInput.placeholder === "What are you craving today?") {
                textInput.placeholder = "Refine your search or try something new...";
            }
            
            try {
                hideError();
                showLoader();
                clearResults();

                const textInput = document.getElementById('textInput').value.trim();
                const timeOfDay = document.getElementById('timeOfDay').value;
                const weather = await getCurrentWeather();
                const socialContext = document.getElementById('socialContext').value;
                const energyLevel = document.getElementById('energyLevel').value;

                if (!textInput) {
                    throw new Error('Please provide a text input');
                }

                const requestData = {
                    text_input: textInput,
                    image_base64: null,
                    audio_base64: null,
                    user_context: {
                        time_of_day: timeOfDay,
                        weather: weather,
                        social_context: socialContext,
                        energy_level: energyLevel
                    }
                };

                if (document.querySelector('.debug-toggle').classList.contains('active')) {
                    document.getElementById('debugRequest').textContent = JSON.stringify(requestData, null, 2);
                }

                const startTime = Date.now();
                const response = await fetch(`${API_BASE}/enhanced-recommend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const endTime = Date.now();

                if (document.querySelector('.debug-toggle').classList.contains('active')) {
                    document.getElementById('debugResponse').textContent = JSON.stringify(data, null, 2);
                    document.getElementById('debugPerformance').textContent = `Response time: ${endTime - startTime}ms`;
                }

                currentRecommendations = data;
                showResults(data);
                showFeedbackSection(data);

            } catch (error) {
                showError(error);
            } finally {
                hideLoader();
            }
        }

        // UI helper functions
        function showLoader() {
            document.getElementById('loadingSection').style.display = 'block';
        }

        function hideLoader() {
            document.getElementById('loadingSection').style.display = 'none';
        }

        function showError(error) {
            const errorSection = document.getElementById('errorSection');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = error.message || 'An unexpected error occurred';
            errorSection.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorSection').style.display = 'none';
        }

        function clearResults() {
            document.getElementById('aiAnalysis').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('recommendationsList').innerHTML = '';
            document.getElementById('feedbackSection').style.display = 'none';
        }

        function showResults(data) {
            showAIAnalysis(data);
            
            const resultsSection = document.getElementById('resultsSection');
            const recommendationsList = document.getElementById('recommendationsList');
            
            if (!data.recommendations || data.recommendations.length === 0) {
                recommendationsList.innerHTML = '<p>No recommendations found. Please try a different input.</p>';
                resultsSection.style.display = 'block';
                return;
            }

            let html = '';
            data.recommendations.forEach((rec, index) => {
                html += `
                    <div class="recommendation-card">
                        <div class="recommendation-header">
                            <div class="food-name">${escapeHtml(rec.food_name || rec.title || rec.name || 'Unknown')}</div>
                            <div class="food-score">${rec.score ? rec.score.toFixed(2) : 'N/A'}</div>
                        </div>
                        
                        <div class="food-details">
                            <div class="detail-item">
                                <div class="detail-label">Category</div>
                                <div class="detail-value">${escapeHtml(rec.food_category || rec.category || 'N/A')}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Region</div>
                                <div class="detail-value">${escapeHtml(rec.food_region || rec.region || 'N/A')}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Culture</div>
                                <div class="detail-value">${escapeHtml(rec.food_culture || rec.culture || 'N/A')}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Mood Match</div>
                                <div class="detail-value">${rec.mood_match ? rec.mood_match.toFixed(2) : 'N/A'}</div>
                            </div>
                        </div>
                        
                        ${rec.reasoning && rec.reasoning.length > 0 ? `
                            <div class="reasoning">
                                <h4>ü§î Why this recommendation?</h4>
                                <ul>
                                    ${rec.reasoning.map(reason => `<li>${escapeHtml(reason)}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            recommendationsList.innerHTML = html;
            resultsSection.style.display = 'block';
        }

        function showAIAnalysis(data) {
            try {
                const analysisDiv = document.getElementById('aiAnalysis');
                
                if (data.intent_prediction && data.intent_prediction.primary_intent) {
                    document.getElementById('primaryIntent').textContent = 
                        data.intent_prediction.primary_intent.replace(/_/g, ' ');
                    
                    const confidence = data.intent_prediction.confidence;
                    document.getElementById('intentConfidence').textContent = 
                        confidence > 0 ? `${(confidence * 100).toFixed(0)}%` : 'N/A';
                }
                
                if (data.processing_time) {
                    document.getElementById('processingTime').textContent = 
                        `${(data.processing_time * 1000).toFixed(0)}ms`;
                }
                
                analysisDiv.style.display = 'block';
            } catch (error) {
                console.error('Error showing AI analysis:', error);
            }
        }
        
        function showFeedbackSection(data) {
            if (data.recommendations && data.recommendations.length > 0) {
                document.getElementById('feedbackSection').style.display = 'block';
            }
        }

        async function submitFeedback() {
            if (!currentRecommendations) return;

            try {
                const feedbackData = {
                    user_id: 'anonymous',
                    session_id: Date.now().toString(),
                    input_text: document.getElementById('textInput').value,
                    recommended_foods: currentRecommendations.recommendations.map(r => r.food_name),
                    selected_food: null,
                    rating: currentRating,
                    feedback_text: document.getElementById('feedbackText').value,
                    context: {
                        time_of_day: document.getElementById('timeOfDay').value,
                        weather: await getCurrentWeather(),
                        social_context: document.getElementById('socialContext').value,
                        energy_level: document.getElementById('energyLevel').value
                    },
                    model_version: currentRecommendations.model_version || '1.0.0'
                };

                const response = await fetch(`${API_BASE}/feedback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(feedbackData)
                });

                if (response.ok) {
                    alert('Thank you for your feedback! It will help improve our recommendations.');
                    currentRating = 0;
                    document.querySelectorAll('.star').forEach(star => star.classList.remove('active'));
                    document.getElementById('feedbackText').value = '';
                } else {
                    throw new Error('Failed to submit feedback');
                }

            } catch (error) {
                alert('Failed to submit feedback: ' + error.message);
            }
        }

        function toggleDebug() {
            const toggle = document.querySelector('.debug-toggle');
            toggle.classList.toggle('active');
            document.getElementById('debugApiBase').textContent = API_BASE;
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Initialize debug info
        document.getElementById('debugApiBase').textContent = API_BASE;
    </script>
</body>
</html> 